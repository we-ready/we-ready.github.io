{"componentChunkName":"component---src-templates-blog-js","path":"/blog/20210130001_linux_docker_timezone","result":{"pageContext":{"frontmatter":{"id":"20210130001_linux_docker_timezone","title":"Linux 服务器及容器的时区设置","subtitle":"程序的执行，往往需要获取系统时间，如果系统时间出现问题，可能会导致程序、系统出现问题。因此，需要正确设置系统的时区和时间。","subject":"docker","author":"Chis Wei","keywords":"容器;时区","tags":"linux;docker;timezone;postgres","category":"经验技巧","cover":null,"created_when":"2021-01-30","updated_when":"2021-01-30","level":200},"excerpt":" Linux 服务器及容器的时区设置\n\n 问题描述\n","html":"<h1>Linux 服务器及容器的时区设置</h1>\n<h2>问题描述</h2>\n<p>程序运行时，前端应用、后端服务、数据库服务、数据表字段，都有各自的时间设置，包括时间日期、时区设置，如果不匹配，有可能会造成时间判断上的错误。</p>\n<h2>背景</h2>\n<h3>数据表</h3>\n<pre><code>created_when        timestamp DEFAULT current_timestamp,\nupdated_when        timestamp DEFAULT current_timestamp,\n</code></pre>\n<blockquote>\n<p>目前数据库的时间字段，采用的是 <code>timestamp</code>，是不带时区信息的时间戳。因此，字段保存的时间信息，由写入时的时间决定。字段读出的信息，就是写入时的当前时间（由当时的时间，和时区设置决定）</p>\n</blockquote>\n<h3>数据库服务器（或容器）</h3>\n<ul>\n<li>由数据库服务器的时间和单独数据库的时区设置决定</li>\n<li>通过 <code>ALTER DATABASE [database-name] SET timezone TO 'Asia/Shanghai';</code></li>\n</ul>\n<h3>服务器</h3>\n<ul>\n<li>服务器的时间，由服务器的时间和时区决定</li>\n<li>通过 <code>date</code> 命名可以查看</li>\n<li>通过 <code>cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code> 可以改变</li>\n</ul>\n<h3>容器</h3>\n<ul>\n<li>容器运行时的时间，由宿主机的时间和容器的时区决定</li>\n<li>通过 <code>date</code> 命名可以查看</li>\n<li>如果是自定义镜像，可以在 <code>Dockerfile</code> 中通过增加 <code>RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code> 改变镜像时区</li>\n<li>如果是标准镜像，可以通过注册表项 <code>TZ=Asia/Shanghai</code> 改变镜像时区</li>\n</ul>\n<h2>解决方案</h2>\n<h3>宿主机</h3>\n<h4>服务器时间自动定时同步更新</h4>\n<pre><code>yum install -y ntpdate\nntpdate -u 210.72.145.44\n</code></pre>\n<h4>设置正确的时区</h4>\n<pre><code>cp /etc/localtime /etc/localtime.bak\ncp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n</code></pre>\n<h3>自定义容器镜像</h3>\n<h4>基于 <code>Nginx</code> 的前端镜像</h4>\n<p><code>Dockerfile</code></p>\n<pre><code>FROM nginx:1.17.6-alpine\n\nRUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\nADD ./runtime/nginx /etc/nginx\nADD ./runtime/www /www\n\n... ...\n</code></pre>\n<h4>基于 <code>Nodejs</code> 的后端镜像</h4>\n<p><code>Dockerfile</code></p>\n<pre><code>FROM node:12.14.1-alpine\n\n# RUN apk update \\\n#     &#x26;&#x26; apk add tzdata \\\n#     &#x26;&#x26; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \\\n#     &#x26;&#x26; echo \"Asia/Shanghai\" > /etc/timezone\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories\nRUN apk add --no-cache tzdata \\\n    &#x26;&#x26; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \\\n    &#x26;&#x26; echo \"Asia/Shanghai\" > /etc/timezone \\\n    &#x26;&#x26;rm -rf /var/cache/apk/* /tmp/* /var/tmp/* $HOME/.cache\n\nADD ./node_modules /node_modules\n\n... ...\n</code></pre>\n<h3>标准镜像（<code>redis</code>，<code>postgres</code>）</h3>\n<p><code>docker-compose.yml</code></p>\n<pre><code>version: '2'\n\nservices:\n  redis:\n    container_name: redis\n    image: 'redis:5.0.7-alpine'\n    restart: always\n    networks:\n      - bridgenet\n    ports:\n      - '6379:6379'\n    environment: \n      - TZ=Asia/Shanghai\n\n... ...\n</code></pre>\n<h3>数据库</h3>\n<h4>服务器</h4>\n<blockquote>\n<p>确保服务器自动生成时间的正确性</p>\n</blockquote>\n<p><code>timezone.sh</code></p>\n<pre><code>psql -v ON_ERROR_STOP=1 --username postgres --dbname [database-name] &#x3C;&#x3C;-EOSQL\n  ALTER DATABASE [database-name] SET timezone TO 'Asia/Shanghai';\nEOSQL\n</code></pre>\n<p><code>docker-entrypoint-initdb.d/initial.sh</code></p>\n<pre><code>#!/bin/bash\nset -e\n\ncd /script\nsh create_db.sh\nsh create_ext.sh\nsh timezone.sh\nsh initial.sh\n\n... ...\n</code></pre>\n<h4>客户端</h4>\n<blockquote>\n<p>确保客户端执行的相关命令，所使用的时间的正确性（如果没有明确设置，缺省会使用数据库的时区设置）</p>\n</blockquote>\n<p><code>timezone.sql</code></p>\n<pre><code>show timezone;\nset timezone='Asia/Shanghai';\nselect current_timestamp;\nshow timezone;\n</code></pre>\n<p><code>initial.sql</code></p>\n<pre><code>\\i timezone.sql;\n\\i ecset.sql;\n\n... ...\n</code></pre>\n<h2>参考内容</h2>\n<h3>服务器时间同步</h3>\n<blockquote>\n<p><a href=\"https://www.cnblogs.com/wangwust/p/11330718.html\">【Linux】- 同步网络时间</a></p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th align=\"right\">时间同步服务</th>\n<th>主机</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"right\">中国国家授时中心</td>\n<td>210.72.145.44</td>\n</tr>\n<tr>\n<td align=\"right\">NTP服务器(上海)</td>\n<td>ntp.api.bz</td>\n</tr>\n<tr>\n<td align=\"right\">美国</td>\n<td>time.nist.gov</td>\n</tr>\n<tr>\n<td align=\"right\">复旦</td>\n<td>ntp.fudan.edu.cn</td>\n</tr>\n<tr>\n<td align=\"right\">微软公司授时主机(美国)</td>\n<td>time.windows.com</td>\n</tr>\n<tr>\n<td align=\"right\">台警大授时中心(台湾)</td>\n<td>asia.pool.ntp.org</td>\n</tr>\n</tbody>\n</table>\n<h3>Linux CentOS</h3>\n<ul>\n<li>timedatectl</li>\n</ul>\n<pre><code># timedatectl\n</code></pre>\n<ul>\n<li>date</li>\n</ul>\n<pre><code># date\n</code></pre>\n<ul>\n<li>set timezone</li>\n</ul>\n<pre><code># cp /etc/localtime /etc/localtime.bak\n# cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n</code></pre>\n<h2>Postgres</h2>\n<h3>客户端</h3>\n<ul>\n<li>localtimestamp, current_timestamp, now()</li>\n</ul>\n<pre><code>select localtimestamp, current_timestamp, now();\n</code></pre>\n<ul>\n<li>show timezone</li>\n</ul>\n<pre><code>=> show timezone;\n</code></pre>\n<ul>\n<li>set timezone</li>\n</ul>\n<pre><code>=> set timezone='Asia/Shanghai';\n</code></pre>\n<blockquote>\n<p>by default the timezone is 'UTC'</p>\n</blockquote>\n<h3>服务端</h3>\n<pre><code>ALTER DATABASE [database-name] SET timezone TO 'Asia/Shanghai\n</code></pre>"}},"staticQueryHashes":["2718502863","3159585216","847266990"]}